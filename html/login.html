<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - SAMS CUEA</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link
      rel="icon"
      href="https://www.cuea.edu/wp-content/uploads/2022/11/CUEA-FAVICON.png"
    />
  </head>
  <body class="bg-light">
    <div
      class="container d-flex justify-content-center align-items-center vh-100"
    >
      <div class="card auth-card">
        <div class="card-body">
          <div class="text-center mb-4">
            <img
              src="/assets/images/CUEA-LOGO.png"
              alt="CUEA Logo"
              style="max-height: 80px"
            />
            <h3 class="mt-3 text-primary">SAMS Login</h3>
          </div>
          <form id="login-form">
            <div class="mb-3">
              <label for="email" class="form-label">Email address</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                class="form-control"
                id="password"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
            <div class="text-center mt-3">
              <a href="/html/forgot-password.html" class="text-muted small"
                >Forgot Password?</a
              >
              <p class="mt-2 mb-0 small">
                Don't have an account? <a href="/html/signup.html">Sign Up</a>
              </p>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div
      id="toast-container"
      class="toast-container position-fixed bottom-0 end-0 p-3"
    ></div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const SUPABASE_URL = "https://flcrrpggontcixtvjchx.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsY3JycGdnb250Y2l4dHZqY2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTkwMDUsImV4cCI6MjA3MTg5NTAwNX0.yee0ZMsSmKCLaKHmEM_7azr-oH0kETyzHmuZOUYXOFo";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Toast helper
      function showToast(message, type = "info") {
        const toastId = "toast-" + Date.now();
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-bg-${type} border-0`;
        toast.id = toastId;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");
        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast" aria-label="Close"></button>
          </div>`;
        document.getElementById("toast-container").appendChild(toast);

        const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
        bsToast.show();
      }

      // --- Redirect logged-in users away from the login page ---
      const checkSession = async () => {
        const {
          data: { session },
          error,
        } = await supabase.auth.getSession();
        if (error) {
          console.error("Session check error:", error);
          return;
        }

        if (session) {
          const { data: userData, error: userError } = await supabase
            .from("users")
            .select("role_id")
            .eq("id", session.user.id)
            .single();

          if (userError || !userData) return;

          const { data: roleData, error: roleError } = await supabase
            .from("roles")
            .select("name")
            .eq("id", userData.role_id)
            .single();

          if (roleError || !roleData) return;

          let redirectUrl = "/html/student-dashboard.html";
          if (roleData.name === "staff") {
            redirectUrl = "/html/staff-dashboard.html";
          } else if (roleData.name === "admin") {
            redirectUrl = "/html/admin-overview.html";
          }

          window.location.href = redirectUrl;
        }
      };
      checkSession();

      // --- Login Form Submission Logic ---
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = e.target.email.value;
          const password = e.target.password.value;

          try {
            const { data: authData, error: authError } =
              await supabase.auth.signInWithPassword({
                email,
                password,
              });
            if (authError) throw authError;

            const user = authData.user;

            const { data: userData, error: userError } = await supabase
              .from("users")
              .select("role_id")
              .eq("id", user.id)
              .single();
            if (userError) throw userError;

            const { data: roleData, error: roleError } = await supabase
              .from("roles")
              .select("name")
              .eq("id", userData.role_id)
              .single();
            if (roleError) throw roleError;

            const role = roleData.name;

            showToast("Login successful! Redirecting...", "success");

            let redirectUrl = "/html/student-dashboard.html";
            if (role === "staff") redirectUrl = "/html/staff-dashboard.html";
            else if (role === "admin")
              redirectUrl = "/html/admin-overview.html";

            setTimeout(() => {
              window.location.href = redirectUrl;
            }, 2000);
          } catch (err) {
            console.error("Login failed:", err);
            showToast("Login failed: " + err.message, "danger");
          }
        });
    </script>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
